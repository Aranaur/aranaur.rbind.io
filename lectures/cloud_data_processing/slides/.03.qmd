---
title: "GCP: Python —Ç–∞ BigQuery"
subtitle: "–•–º–∞—Ä–Ω—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö"
author: "–Ü–≥–æ—Ä –ú—ñ—Ä–æ—à–Ω–∏—á–µ–Ω–∫–æ"
institute: –ö–ù–£ —ñ–º–µ–Ω—ñ –¢–∞—Ä–∞—Å–∞ –®–µ–≤—á–µ–Ω–∫–∞ | –§–Ü–¢
# date: today
# date-format: iso
from: markdown+emoji
title-slide-attributes:
  data-background-iframe: .01_files/libs/colored-particles/index.html
#   data-background-color: "#eef3f8"
lang: ua
footer: üîó <a href="https://aranaur.rbind.io/lectures/cloud_data_processing/">–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ –∫—É—Ä—Å—É</a>
format: 
  html:
    toc: true
    code-line-numbers: false
    highlight-style: github
    pdf-separate-fragments: true
    # fig-height: 7.5
    fig-width: 15
    fig-align: center
    fig-format: svg
    theme: [default, custom.scss]
jupyter: python3
execute: 
  warning: false
  echo: true
---

```{python}
#| label: setup
#| include: false
#| eval: false

# Import libraries
import numpy as np
import pandas as pd
import statsmodels.api as sm
import statsmodels.formula.api as smf
import matplotlib.pyplot as plt
import seaborn as sns
from scipy.stats import norm, uniform, t

from IPython.display import Markdown
from tabulate import tabulate

# Set seaborn default style
sns.set_style('whitegrid')
sns.set_palette('colorblind')

# Define colors
red_pink   = "#e64173"
turquoise  = "#20B2AA"
orange     = "#FFA500"
red        = "#fb6107"
blue       = "#181485"
navy       = "#150E37FF"
green      = "#8bb174"
yellow     = "#D8BD44"
# grey_light = "grey70"
# grey_mid   = "grey50"
# grey_dark  = "grey20"
purple     = "#6A5ACD"
slate      = "#314f4f"
```

## –í–∏–º–æ–≥–∏

1. –ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ BigQuery API –≤ –∫–æ–Ω—Å–æ–ª—ñ GCP
2. –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É `google-cloud-bigquery`:

```bash
pip install --upgrade google-cloud-bigquery
pip install db-dtypes
```

3. –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å–µ—Ä–≤—ñ—Å–Ω–∏–π –∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ BigQuery API (Role: Basic, Roles: Owner) —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –π–æ–≥–æ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∏–π –∫–æ–º–ø'—é—Ç–µ—Ä.

## –ü–æ—á–∞—Ç–æ–∫ —Ä–æ–±–æ—Ç–∏ –∑ API

```{python}
#| label: bigquery-setup

import os
from google.cloud import bigquery
import time
import pandas as pd

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–µ—Ä–≤—ñ—Å–Ω–æ–≥–æ –∫–ª—é—á–∞
os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "./data/fit-cloud-course-key.json"
```

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞

```{python}
#| label: client

client = bigquery.Client('fit-cloud-course')
```

### –ó–∞–ø–∏—Ç–∏ –¥–æ BigQuery

```{python}
#| label: query

sql_query = """
SELECT station_id, name, dockcount
FROM `bigquery-public-data.san_francisco.bikeshare_stations`
LIMIT 5
"""
```

### –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É

```{python}
#| label: execute

query_job = client.query(sql_query)

print(query_job)
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–∞–ø–∏—Ç—É

```{python}
#| label: results-1

for row in query_job:
    print(row)
```

```{python}
#| label: results-2

for row in query_job:
    print(row[0], row[1], row[2], sep=" | ")
```

```{python}
#| label: results-3

for row in query_job:
    print(row.station_id, row.name, row.dockcount, sep=" | ")
```

## –ú—ñ—Ç–∫–∏ –¥–∞–Ω–∏—Ö —É BigQuery

–ú—ñ—Ç–∫–∞ ‚Äì —Ü–µ –ø–∞—Ä–∞ –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–Ω—è, —è–∫—É –º–æ–∂–Ω–∞ –ø—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ —Ä–µ—Å—É—Ä—Å–∞–º Google Cloud BigQuery. –í–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ –º—ñ—Ç–∫—É –¥–æ –∫–æ–∂–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å—É, –∞ –ø–æ—Ç—ñ–º –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ —Ä–µ—Å—É—Ä—Å–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ó—Ö–Ω—ñ—Ö –º—ñ—Ç–æ–∫.

–û—Å—å –∫—ñ–ª—å–∫–∞ —Ç–∏–ø–æ–≤–∏—Ö –≤–∏–ø–∞–¥–∫—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –º—ñ—Ç–æ–∫:

- **–ú—ñ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥–∏:** `team:research` –∞–±–æ `team:analytics`.
- **–ú—ñ—Ç–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤:** –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `component:redis`, `component:frontend`, `component:ingest—Ç–∞`, `component:dashboard` —Ç–æ—â–æ.
- **–ú—ñ—Ç–∫–∏ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞:** `environment:production` —ñ `environment:test`.
- **–ú—ñ—Ç–∫–∏ —Å—Ç–∞–Ω—É:** `state:active`, `state:readytodelete` —ñ `state:archive`.
- **–ú—ñ—Ç–∫–∏ –≤–ª–∞—Å–Ω–æ—Å—Ç—ñ:** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–æ–º–∞–Ω–¥, —è–∫—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –∑–∞ –æ–ø–µ—Ä–∞—Ü—ñ—ó, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ `team:shopping-cart`.

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ

```{python}
#| label: create-table-1

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–∞–±–ª–∏—Ü—é
dataset_ref = bigquery.DatasetReference(client.project, 'dsongcp')

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
table_ref = bigquery.TableReference(dataset_ref, 'flights_auto')
```

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º—ñ—Ç–æ–∫

```{python}
#| label: labels

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º—ñ—Ç–æ–∫
labels = {
    'type': 'auto',
    'category': 'transport'
}

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –∑ –º—ñ—Ç–∫–∞–º–∏
flights_auto_table = client.get_table(table_ref)
# –î–æ–¥–∞–≤–∞–Ω–Ω—è –º—ñ—Ç–æ–∫
flights_auto_table.labels = labels
# –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
client.update_table(flights_auto_table, ['labels'])
```

### –û–Ω–æ–≤–ª–µ–Ω–Ω—è –º—ñ—Ç–æ–∫

```{python}
#| label: update-labels

# –û–Ω–æ–≤–ª–µ–Ω–Ω—è –º—ñ—Ç–æ–∫
new_labels = {
    'type': 'auto',
    'category': 'transport',
    'year': '2015'
}

flights_auto_table = client.get_table(table_ref)
flights_auto_table.labels = new_labels
client.update_table(flights_auto_table, ['labels'])
```

### –í–∏–¥–∞–ª–µ–Ω–Ω—è –º—ñ—Ç–æ–∫

```{python}
#| label: delete-labels

table = client.get_table(table_ref)
labels = table.labels
labels = {k: None for k, v in labels.items()}
table.labels = labels
client.update_table(table, ['labels'])
```

## –î–æ–¥–∞–≤–∞–Ω–Ω—è/–≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö

```{python}
#| label: columns

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
dataset_ref = bigquery.DatasetReference(client.project, 'dsongcp')
table_ref = bigquery.TableReference(dataset_ref, 'flights_auto')
bigquery_table = client.get_table(table_ref)
```

–û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ö–µ–º–∏ —Ç–∞–±–ª–∏—Ü—ñ:

```{python}
#| label: schema

schema = bigquery_table.schema
schema[:5]
```

–°—Ç–≤–æ—Ä–∏–º–æ –∫–æ–ø—ñ—é —Å—Ö–µ–º–∏:

```{python}
#| label: copy-schema

new_schema = schema.copy()
```

–î–æ–¥–∞–º–æ –Ω–æ–≤—É –∑–º—ñ–Ω–Ω—É —É —Å—Ö–µ–º—É:

```{python}
#| label: add-column

new_schema.append(bigquery.SchemaField('Distance_km', 'FLOAT64', mode='NULLABLE'))
# –ü–µ—Ä–µ–¥–∞–º–æ –æ–Ω–æ–≤–ª–µ–Ω—É —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ñ bigquery_table
bigquery_table.schema = new_schema
```

::: callout-note
–¢–∏–ø–∏ –¥–∞–Ω–∏—Ö –≤ BigQuery: <https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types>.
:::

–¢–µ–ø–µ—Ä –∑—Ä–æ–±–∏–º–æ –∑–∞–ø–∏—Ç –Ω–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ:

```{python}
#| label: update-schema

client.update_table(bigquery_table, ['schema'])
```

–ü–µ—Ä–µ–≥–ª—è–Ω–µ–º–æ –æ–Ω–æ–≤–ª–µ–Ω—É —Å—Ö–µ–º—É:

```{python}
#| label: updated-schema

bigquery_table = client.get_table(table_ref)
schema = bigquery_table.schema
schema[-5:]
```

–í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–º—ñ–Ω–Ω–æ—ó –∑ —Å—Ö–µ–º–∏:

```{python}
#| label: delete-column

query_job = client.query("""
    ALTER TABLE dsongcp.flights_auto
    DROP COLUMN IF EXISTS Distance_km;
""")
```

–Ü–Ω–æ–¥—ñ –∑–∞–ø–∏—Ç –º–æ–∂–µ –∑–∞–π–º–∞—Ç–∏ –¥–µ—è–∫–∏–π —á–∞—Å –Ω–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è. –©–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Ç—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –º–µ—Ç–æ–¥ `query_job.state`:

```{python}
#| label: query-status

while query_job.state != 'DONE': 
    print('–ó–∞–ø–∏—Ç –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è...')
    time.sleep(3)
    query_job.reload()
print(query_job.result())
```

## –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –∑–∞–ø–∏—Ç—É –≤ —Ç–∞–±–ª–∏—Ü—é

–ù–∞–ø–∏—à–µ–º–æ –∑–∞–ø–∏—Ç, —è–∫–∏–π –≤–∏–±–µ—Ä–µ —Å–µ—Ä–µ–¥–Ω—é –∑–∞—Ç—Ä–∏–º–∫—É –≤–∏–ª—å–æ—Ç—É —Ç–∞ –ø—Ä–∏–±—É—Ç—Ç—è –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∞–µ—Ä–æ–ø–æ—Ä—Ç—É –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:

```{python}
#| label: base-query

sql_query = """
SELECT
  ORIGIN,
  AVG(DepDelay) AS dep_delay,
  AVG(ArrDelay) AS arr_delay,
  COUNT(ArrDelay) AS num_flights
FROM
  `dsongcp.flights_auto`
GROUP BY
  ORIGIN
ORDER BY num_flights DESC
LIMIT 10
"""
```

–°—Ç–≤–æ—Ä–∏–º–æ –æ–∫—Ä–µ–º–∏–π –¥–∞—Ç–∞—Å–µ—Ç, –∫—É–¥–∏ –º–∏ –∑–±–µ—Ä–µ–∂–µ–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–∞–ø–∏—Ç—É:

```{python}
#| label: create-dataset

dataset_id = client.project + '.dsongcp_results'
dataset = bigquery.Dataset(dataset_id)
dataset.location = "US"
dataset = client.create_dataset(dataset, exists_ok=True)
print(f"–°—Ç–≤–æ—Ä–µ–Ω–æ –¥–∞—Ç–∞—Å–µ—Ç {client.project}.{dataset.dataset_id}")
```

–í–∏–∑–Ω–∞—á–∏–º–æ —Ç–∞–±–ª–∏—Ü—é, –≤ —è–∫—É –º–∏ –∑–±–µ—Ä–µ–∂–µ–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–∞–ø–∏—Ç—É:

```{python}
#| label: table-info

project_id = client.project
dataset_id = 'dsongcp_results'
table_id = 'flights_delay'
```

–í–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ –º–µ—Ç–æ–¥ `from_string()` –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–∞–±–ª–∏—Ü—é:

```{python}
#| label: create-table-2

table_ref = bigquery.TableReference.from_string(f"{project_id}.{dataset_id}.{table_id}")
table_ref
```

–í–∏–∫–æ–Ω–∞—î–º–æ –∑–∞–ø–∏—Ç —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –≤ —Ç–∞–±–ª–∏—Ü—é:

```{python}
#| label: save-results

job_config = bigquery.QueryJobConfig(destination=table_ref, write_disposition="WRITE_TRUNCATE")
query_job = client.query(sql_query, job_config=job_config)
while query_job.state != 'DONE': 
    print('–ó–∞–ø–∏—Ç –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è...')
    time.sleep(3)
    query_job.reload()
print(query_job.result())
```

::: callout-note
–ë—ñ–ª—å—à–µ –ø—Ä–æ `QueryJobConfig` –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º <https://cloud.google.com/python/docs/reference/bigquery/latest/google.cloud.bigquery.job.QueryJobConfig>
:::

## –ó–∞–ø–∏—Ç —É DataFrame

–î–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ —Ä–æ–±–æ—Ç–∏ –∑ –¥–∞–Ω–∏–º–∏ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É `pandas`. –î–ª—è —Ü—å–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ –º–µ—Ç–æ–¥ `to_dataframe()`:

```{python}
#| label: to-dataframe

query_job = client.query(sql_query)
df = query_job.to_dataframe()
df
```

## –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω—ñ –∑–∞–ø–∏—Ç–∏

–ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω—ñ –∑–∞–ø–∏—Ç–∏ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–Ω—ñ –≤ –∑–∞–ø–∏—Ç–∞—Ö. –¶–µ –¥–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –æ–¥–∏–Ω —ñ —Ç–æ–π –∂–µ –∑–∞–ø–∏—Ç –∑ —Ä—ñ–∑–Ω–∏–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏ –∑–º—ñ–Ω–Ω–∏—Ö.

–î–ª—è —Ü—å–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Å–∏–º–≤–æ–ª `@` –ø–µ—Ä–µ–¥ –∑–º—ñ–Ω–Ω–æ—é –≤ –∑–∞–ø–∏—Ç—ñ. –í–∏–∑–Ω–∞—á–∏–º–æ –ø–∞—Ä–∞–º–µ—Ç—Ä `month` —Ç–∞ –≤–∏–∫–æ–Ω–∞—î–º–æ –∑–∞–ø–∏—Ç:

```{python}
#| label: query-params

query_params = [
    bigquery.ScalarQueryParameter("month", "INT64", 1)
]
```

```{python}
#| label: param-query

sql_query = """
SELECT
  ORIGIN,
  AVG(DepDelay) AS dep_delay,
  AVG(ArrDelay) AS arr_delay,
  COUNT(ArrDelay) AS num_flights
FROM
  `dsongcp.flights_auto`
WHERE
  Month = @month
GROUP BY
  ORIGIN
ORDER BY num_flights DESC
LIMIT 10
"""
```

```{python}
#| label: execute-params

job_config = bigquery.QueryJobConfig(query_parameters=query_params)
query_job = client.query(sql_query, job_config=job_config)
df = query_job.to_dataframe()
df
```









