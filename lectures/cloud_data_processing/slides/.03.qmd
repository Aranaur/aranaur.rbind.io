---
title: "GCP: Python —Ç–∞ BigQuery"
subtitle: "–•–º–∞—Ä–Ω—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö"
author: "–Ü–≥–æ—Ä –ú—ñ—Ä–æ—à–Ω–∏—á–µ–Ω–∫–æ"
institute: –ö–ù–£ —ñ–º–µ–Ω—ñ –¢–∞—Ä–∞—Å–∞ –®–µ–≤—á–µ–Ω–∫–∞ | –§–Ü–¢
# date: today
# date-format: iso
from: markdown+emoji
title-slide-attributes:
  data-background-iframe: .01_files/libs/colored-particles/index.html
#   data-background-color: "#eef3f8"
lang: ua
footer: üîó <a href="https://aranaur.rbind.io/lectures/cloud_data_processing/">–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ –∫—É—Ä—Å—É</a>
format: 
  html:
    toc: true
    code-line-numbers: false
    highlight-style: github
    pdf-separate-fragments: true
    # fig-height: 7.5
    fig-width: 15
    fig-align: center
    fig-format: svg
    theme: [default, custom.scss]
jupyter: python3
execute: 
  warning: false
  echo: true
---

```{python}
#| label: setup
#| include: false
#| eval: false

# Import libraries
import numpy as np
import pandas as pd
import statsmodels.api as sm
import statsmodels.formula.api as smf
import matplotlib.pyplot as plt
import seaborn as sns
from scipy.stats import norm, uniform, t

from IPython.display import Markdown
from tabulate import tabulate

# Set seaborn default style
sns.set_style('whitegrid')
sns.set_palette('colorblind')

# Define colors
red_pink   = "#e64173"
turquoise  = "#20B2AA"
orange     = "#FFA500"
red        = "#fb6107"
blue       = "#181485"
navy       = "#150E37FF"
green      = "#8bb174"
yellow     = "#D8BD44"
# grey_light = "grey70"
# grey_mid   = "grey50"
# grey_dark  = "grey20"
purple     = "#6A5ACD"
slate      = "#314f4f"
```

## –í–∏–º–æ–≥–∏

1. –ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ BigQuery API –≤ –∫–æ–Ω—Å–æ–ª—ñ GCP
2. –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É `google-cloud-bigquery`:

```bash
pip install --upgrade google-cloud-bigquery
```

3. –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å–µ—Ä–≤—ñ—Å–Ω–∏–π –∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ BigQuery API —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –π–æ–≥–æ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∏–π –∫–æ–º–ø'—é—Ç–µ—Ä.

## –ü–æ—á–∞—Ç–æ–∫ —Ä–æ–±–æ—Ç–∏ –∑ API

```{python}
#| label: bigquery-setup

import os
from google.cloud import bigquery

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–µ—Ä–≤—ñ—Å–Ω–æ–≥–æ –∫–ª—é—á–∞
os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "./data/fit-cloud-course-key.json"
```

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞

```{python}
#| label: client

client = bigquery.Client('fit-cloud-course')
```

### –ó–∞–ø–∏—Ç–∏ –¥–æ BigQuery

```{python}
#| label: query

sql_query = """
SELECT station_id, name, dockcount
FROM `bigquery-public-data.san_francisco.bikeshare_stations`
LIMIT 5
"""
```

### –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É

```{python}
#| label: execute

query_job = client.query(sql_query)

print(query_job)
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–∞–ø–∏—Ç—É

```{python}
#| label: results-1

for row in query_job:
    print(row)
```

```{python}
#| label: results-2

for row in query_job:
    print(row[0], row[1], row[2], sep=" | ")
```

```{python}
#| label: results-3

for row in query_job:
    print(row.station_id, row.name, row.dockcount, sep=" | ")
```

## –î–æ–¥–∞–≤–∞–Ω–Ω—è, –æ–Ω–æ–≤–ª–µ–Ω–Ω—è, –≤–∏–¥–∞–ª–µ–Ω–Ω—è –º—ñ—Ç–æ–∫ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é API BigQuery –Ω–∞ Python

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ

```{python}
#| label: create-table

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–∞–±–ª–∏—Ü—é
dataset_ref = bigquery.DatasetReference(client.project, 'Staging')

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
table_ref = bigquery.TableReference(dataset_ref, 'AZURE')
```

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º—ñ—Ç–æ–∫

```{python}
#| label: labels

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º—ñ—Ç–æ–∫
labels = {
    'type': 'social_media',
    'category': 'cloud_computing'
}

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –∑ –º—ñ—Ç–∫–∞–º–∏
azure_table = client.get_table(table_ref)
azure_table.labels = labels
client.update_table(azure_table, ['labels'])
```





