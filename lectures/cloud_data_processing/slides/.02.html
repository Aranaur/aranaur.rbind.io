<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ua" xml:lang="ua"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.547">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ігор Мірошниченко">

<title>Google Cloud Console</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src=".02_files/libs/clipboard/clipboard.min.js"></script>
<script src=".02_files/libs/quarto-html/quarto.js"></script>
<script src=".02_files/libs/quarto-html/popper.min.js"></script>
<script src=".02_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src=".02_files/libs/quarto-html/anchor.min.js"></script>
<link href=".02_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href=".02_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src=".02_files/libs/bootstrap/bootstrap.min.js"></script>
<link href=".02_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href=".02_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Зміст</h2>
   
  <ul>
  <li><a href="#вимоги" id="toc-вимоги" class="nav-link active" data-scroll-target="#вимоги">Вимоги</a>
  <ul class="collapse">
  <li><a href="#створіть-обліковий-запис-на-google-cloud-platform-безкоштовно" id="toc-створіть-обліковий-запис-на-google-cloud-platform-безкоштовно" class="nav-link" data-scroll-target="#створіть-обліковий-запис-на-google-cloud-platform-безкоштовно">Створіть обліковий запис на Google Cloud Platform (безкоштовно)</a></li>
  </ul></li>
  <li><a href="#вступ" id="toc-вступ" class="nav-link" data-scroll-target="#вступ">Вступ</a>
  <ul class="collapse">
  <li><a href="#до-хмари" id="toc-до-хмари" class="nav-link" data-scroll-target="#до-хмари">До хмари!</a></li>
  <li><a href="#початок-роботи" id="toc-початок-роботи" class="nav-link" data-scroll-target="#початок-роботи">Початок роботи</a></li>
  </ul></li>
  <li><a href="#дослідження-даних-у-gcp" id="toc-дослідження-даних-у-gcp" class="nav-link" data-scroll-target="#дослідження-даних-у-gcp">Дослідження даних у GCP</a>
  <ul class="collapse">
  <li><a href="#дані" id="toc-дані" class="nav-link" data-scroll-target="#дані">Дані</a></li>
  <li><a href="#змінні" id="toc-змінні" class="nav-link" data-scroll-target="#змінні">Змінні</a></li>
  <li><a href="#завантаження" id="toc-завантаження" class="nav-link" data-scroll-target="#завантаження">Завантаження</a></li>
  <li><a href="#завантаження-даних-у-google-cloud-storage" id="toc-завантаження-даних-у-google-cloud-storage" class="nav-link" data-scroll-target="#завантаження-даних-у-google-cloud-storage">Завантаження даних у Google Cloud Storage</a></li>
  </ul></li>
  <li><a href="#bigquery" id="toc-bigquery" class="nav-link" data-scroll-target="#bigquery">BigQuery</a>
  <ul class="collapse">
  <li><a href="#завантаження-даних" id="toc-завантаження-даних" class="nav-link" data-scroll-target="#завантаження-даних">Завантаження даних</a></li>
  </ul></li>
  <li><a href="#дашборди" id="toc-дашборди" class="nav-link" data-scroll-target="#дашборди">Дашборди</a>
  <ul class="collapse">
  <li><a href="#створення-представлень" id="toc-створення-представлень" class="nav-link" data-scroll-target="#створення-представлень">Створення представлень</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Google Cloud Console</h1>
<p class="subtitle lead">Хмарні технології обробки даних</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Автор</div>
  <div class="quarto-title-meta-heading">Приналежність</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Ігор Мірошниченко </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            КНУ імені Тараса Шевченка | ФІТ
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  


</header>


<section id="вимоги" class="level2">
<h2 class="anchored" data-anchor-id="вимоги">Вимоги</h2>
<section id="створіть-обліковий-запис-на-google-cloud-platform-безкоштовно" class="level3">
<h3 class="anchored" data-anchor-id="створіть-обліковий-запис-на-google-cloud-platform-безкоштовно">Створіть обліковий запис на Google Cloud Platform (безкоштовно)</h3>
<p>Наступні інструкції є важливими, тому, будь ласка, уважно прочитайте їх.</p>
<ol type="1">
<li>Підпишіться на [3-місячну ($300+$100 кредит) безкоштовну пробну версію] (<a href="https://console.cloud.google.com/freetrial" class="uri">https://console.cloud.google.com/freetrial</a>) Google Cloud Platform (GCP). Для цього потрібен наявний обліковий запис Google/Gmail<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Під час реєстрації вам буде запропоновано ввести дані кредитної картки для виставлення рахунку. Не хвилюйтеся, з вас не стягуватимуться кошти доти, доки ви не зробите активний запит на продовження доступу до GCP після завершення безкоштовної пробної версії. Але для отримання доступу до платформи необхідно мати ідентифікатор проекту, який підлягає оплаті.</li>
<li>(<em>Опціонально</em>) Завантажте та дотримуйтесь інструкцій з встановлення утиліти командного рядка <a href="https://cloud.google.com/sdk/">Google Cloud SDK</a> <code>gcloud</code>.</li>
</ol>
</section>
</section>
<section id="вступ" class="level2">
<h2 class="anchored" data-anchor-id="вступ">Вступ</h2>
<section id="до-хмари" class="level3">
<h3 class="anchored" data-anchor-id="до-хмари">До хмари!</h3>
<p>Найпростіший і найдешевший спосіб отримати доступ до більших обчислювальних потужностей сьогодні - це хмара<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. Хоча є багато чудових постачальників хмарних послуг, я зосереджуся на <a href="https://console.cloud.google.com/"><strong>Google Cloud Platform</strong></a> (<strong>GCP</strong>)<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. GCP пропонує низку неймовірно корисних сервісів, про деякі з яких ми розповімо в наступних лекціях, а 3-місячна безкоштовна пробна версія є ідеальною відправною точкою для вивчення хмарних обчислень.</p>
</section>
<section id="початок-роботи" class="level3">
<h3 class="anchored" data-anchor-id="початок-роботи">Початок роботи</h3>
<ol type="1">
<li>Увійдіть в <a href="https://console.cloud.google.com/">Google Cloud Console</a>.</li>
<li>Виберіть або створіть проект.</li>
<li>Відкрийте Cloud Shell<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</li>
<li>Введіть команду для копіювання файлів з цього репозиторію:</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/aranaur/data-science-on-gcp</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> data-science-on-gcp</span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="дослідження-даних-у-gcp" class="level2">
<h2 class="anchored" data-anchor-id="дослідження-даних-у-gcp">Дослідження даних у GCP</h2>
<section id="дані" class="level3">
<h3 class="anchored" data-anchor-id="дані">Дані</h3>
<p>В якості даних будемо використовувати <a href="https://www.bts.gov/topics/airline-time-tables">Airline On-Time Performance Data</a>.</p>
<p>Усі великі авіаперевізники США зобов’язані подавати статистичні дані про кожен свій внутрішній рейс до Служби транспортної безпеки (BTS).</p>
<p>Дані, які вони зобов’язані подавати, включають запланований час вильоту та прибуття, а також фактичний час вильоту та прибуття. На основі запланованого та фактичного часу прибуття можна розрахувати затримку прибуття, пов’язану з кожним рейсом.</p>
<p>Фактичний час вильоту і прибуття визначається досить точно, виходячи з того, коли відпускається стоянкове гальмо літака і коли воно знову вмикається в пункті призначення. Правила навіть визначають, що станеться, якщо пілот забуде увімкнути стоянкове гальмо - в такому випадку замість нього використовується час закриття або відкриття пасажирських дверей.</p>
<p><img src="img/flight.jpg" class="img-fluid"></p>
</section>
<section id="змінні" class="level3">
<h3 class="anchored" data-anchor-id="змінні">Змінні</h3>
<p>Датасет містить понад 100 змінних, але ми використаємо лише деякі з них:</p>
<table class="table">
<colgroup>
<col style="width: 57%">
<col style="width: 42%">
</colgroup>
<thead>
<tr class="header">
<th>Змінна</th>
<th>Опис</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>FlightDate</code></td>
<td>Дата польоту (yyyymmdd)</td>
</tr>
<tr class="even">
<td><code>Reporting_Airline</code></td>
<td>Унікальний код оператора. Якщо один і той самий код використовувався кількома перевізниками, для більш ранніх користувачів використовується цифровий суфікс, наприклад, PA, PA(1), PA(2). Використовуйте це поле для аналізу за різні роки.</td>
</tr>
<tr class="odd">
<td><code>Origin</code></td>
<td>Аеропорт вильоту</td>
</tr>
<tr class="even">
<td><code>Dest</code></td>
<td>Аеропорт призначення</td>
</tr>
<tr class="odd">
<td><code>CRSDepTime</code></td>
<td>Час відправлення комп’ютерної системи бронювання (CRS) (місцевий час: hhmm)</td>
</tr>
<tr class="even">
<td><code>DepTime</code></td>
<td>Фактичний час відправлення (місцевий час: hhmm)</td>
</tr>
<tr class="odd">
<td><code>DepDelay</code></td>
<td>Різниця в хвилинах між запланованим і фактичним часом відправлення. Ранні відправлення показують від’ємні числа.</td>
</tr>
<tr class="even">
<td><code>TaxiOut</code></td>
<td>Тривалість таксі-ауту, в хвилинах</td>
</tr>
<tr class="odd">
<td><code>WheelsOff</code></td>
<td>Час висадки (місцевий час: hhmm)</td>
</tr>
<tr class="even">
<td><code>WheelsOn</code></td>
<td>Час відправлення (місцевий час: hhmm)</td>
</tr>
<tr class="odd">
<td><code>TaxiIn</code></td>
<td>Тривалість таксі (хвилини)</td>
</tr>
<tr class="even">
<td><code>CRSArrTime</code></td>
<td>Час прибуття CRS (місцевий час: hhmm)</td>
</tr>
<tr class="odd">
<td><code>ArrTime</code></td>
<td>Фактичний час прибуття (місцевий час: hhmm)</td>
</tr>
<tr class="even">
<td><code>ArrDelay</code></td>
<td>Різниця в хвилинах між запланованим і фактичним часом прибуття. Ранні прибуття показують від’ємні значення.</td>
</tr>
<tr class="odd">
<td><code>Cancelled</code></td>
<td>Індикатор скасованого польоту (1 = Так)</td>
</tr>
<tr class="even">
<td><code>CancellationCode</code></td>
<td>Причину скасування</td>
</tr>
<tr class="odd">
<td><code>Diverted</code></td>
<td>Індикатор відхиленого польоту (1 = Так)</td>
</tr>
<tr class="even">
<td><code>Distance</code></td>
<td>Відстань між аеропортами (милі)</td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Примітка
</div>
</div>
<div class="callout-body-container callout-body">
<p>Весь перелік змінних доступний за посиланням <a href="https://www.transtats.bts.gov/Fields.asp?gnoyr_VQ=FGJ" class="uri">https://www.transtats.bts.gov/Fields.asp?gnoyr_VQ=FGJ</a>.</p>
</div>
</div>
</section>
<section id="завантаження" class="level3">
<h3 class="anchored" data-anchor-id="завантаження">Завантаження</h3>
<p>За допомогою інструмента розробника браузера подивимось куди звертається веб-сайт, коли ми вводимо запит на завантаження даних.</p>
<p>Перейдіть за посиланням <a href="https://www.transtats.bts.gov/DL_SelectFields.aspx?gnoyr_VQ=FGJ&amp;QO_fu146_anzr=b0-gvzr" class="uri">https://www.transtats.bts.gov/DL_SelectFields.aspx?gnoyr_VQ=FGJ&amp;QO_fu146_anzr=b0-gvzr</a> та оберіть опцію “Prezipped File”.</p>
<p>Відкрийте вкладку “Network” в інструментах розробника браузера та введіть запит на завантаження даних.</p>
<p>Ми побачимо, що відбувається запит до <a href="https://transtats.bts.gov/PREZIP/On_Time_Reporting_Carrier_On_Time_Performance_1987_present_2023_1.zip" class="uri">https://transtats.bts.gov/PREZIP/On_Time_Reporting_Carrier_On_Time_Performance_1987_present_2023_1.zip</a>.</p>
<p>Видно, з чого складається шаблон запиту:</p>
<pre><code>${Базовий_рік}_${Рік}_${Місяць}.zip</code></pre>
<p>Спробуємо з командного рядка:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="va">BTS</span><span class="op">=</span>https://transtats.bts.gov/PREZIP</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="va">BASEURL</span><span class="op">=</span><span class="st">"</span><span class="va">${BTS}</span><span class="st">/On_Time_Reporting_Carrier_On_Time_Performance_1987_present"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="va">YEAR</span><span class="op">=</span>2015</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="va">MONTH</span><span class="op">=</span>3</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-k</span> <span class="at">-o</span> temp.zip <span class="va">${BASEURL}</span>_<span class="va">${YEAR}</span>_<span class="va">${MONTH}</span>.zip</span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Примітка
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><code>curl</code> - це утиліта командного рядка для взаємодії з серверами за допомогою різних протоколів. В даному випадку ми використовуємо протокол HTTP.</li>
<li><code>-k</code> вказує на те, що ми дозволяємо <code>curl</code> використовувати незахищене з’єднання.</li>
<li><code>-o</code> вказує на те, що ми хочемо зберегти результат у файл <code>temp.zip</code>.</li>
</ul>
</div>
</div>
<p>Розпакуємо архів:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span> temp.zip</span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Тепер видно, що у середині архіву знаходиться CSV-файл. Подивимось на перші кілька рядків:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span> <span class="at">-n</span> 5 <span class="pp">*</span>.csv</span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Замість того, щоб назвати завантажений файл <code>temp.zip</code>, давайте назвемо його <code>201503.zip</code> і помістимо у тимчасовий каталог. Щоб замінити місяць <code>3</code> на <code>03</code>, ми можемо скористатися командою <code>printf</code> у bash:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="va">MONTH2</span><span class="op">=</span><span class="va">$(</span><span class="bu">printf</span> <span class="st">"%02d"</span> <span class="va">$MONTH)</span></span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Для створення каталогу використаємо команду <code>mkdir</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="va">TMPDIR</span><span class="op">=</span><span class="va">$(</span><span class="fu">mktemp</span> <span class="at">-d</span><span class="va">)</span></span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Тепер для завантаження даних використаємо команду <code>curl</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="va">ZIPFILE</span><span class="op">=</span><span class="va">${TMPDIR}</span>/<span class="va">${YEAR}</span>_<span class="va">${MONTH2}</span>.zip</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-o</span> <span class="va">$ZIPFILE</span> <span class="va">${BASEURL}</span>_<span class="va">${YEAR}</span>_<span class="va">${MONTH}</span>.zip</span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Тепер ми можемо розархівувати файл, витягти CSV-файл до поточного каталогу (<code>./</code>) і видалити решту вмісту ZIP-файлу:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span> <span class="at">-d</span> <span class="va">$TMPDIR</span> <span class="va">$ZIPFILE</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mv</span> <span class="va">$TMPDIR</span>/<span class="pp">*</span>.csv ./<span class="va">${YEAR}${MONTH2}</span>.csv</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-rf</span> <span class="va">$TMPDIR</span></span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Всі попередні команди містяться у файлі під назвою <code>download.sh</code>, а потім у скрипті <code>ingest.sh</code> викликаємо їх з циклу <code>for</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> MONTH <span class="kw">in</span> <span class="kw">`</span><span class="fu">seq</span> 1 12<span class="kw">`;</span> <span class="cf">do</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">bask</span> download.sh <span class="va">$YEAR</span> <span class="va">$MONTH</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Виконаємо скрипт:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> MONTH <span class="kw">in</span> <span class="kw">`</span><span class="fu">seq</span> 1 12<span class="kw">`;</span> <span class="cf">do</span> <span class="fu">bash</span> ../02_ingest/download.sh 2015 <span class="va">$MONTH</span><span class="kw">;</span> <span class="cf">done</span></span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Подивимось на кількість рядків у файлах:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wc</span> <span class="at">-l</span> <span class="pp">*</span>.csv</span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="завантаження-даних-у-google-cloud-storage" class="level3">
<h3 class="anchored" data-anchor-id="завантаження-даних-у-google-cloud-storage">Завантаження даних у Google Cloud Storage</h3>
<p>Тепер, коли ми завантажили дані, давайте завантажимо їх у Google Cloud Storage (GCS). Це дозволить нам використовувати їх у інших сервісах GCP, таких як BigQuery, Dataflow, Dataproc, AI Platform тощо.</p>
<p>Спочатку треба створити новий бакет - це контейнер для зберігання даних з унікальним іменем.</p>
<p>Ви можете створити унікальне бакет в командному рядку за допомогою:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="va">PROJECT</span><span class="op">=</span><span class="va">$(</span><span class="ex">gcloud</span> config get-value project<span class="va">)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="va">BUCKET</span><span class="op">=</span><span class="va">${PROJECT}</span>-dsongcp</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="va">REGION</span><span class="op">=</span>us-central1 <span class="co"># Дивіться https://cloud.google.com/storage/docs/locations</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="ex">gsutil</span> mb <span class="at">-l</span> <span class="va">$REGION</span> gs://<span class="va">$BUCKET</span></span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Тепер, коли бакет створено, ми можемо завантажити файли у нього:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gsutil</span> <span class="at">-m</span> cp <span class="pp">*</span>.csv gs://fit-cloud-course-dsongcp/flights/raw/</span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="bigquery" class="level2">
<h2 class="anchored" data-anchor-id="bigquery">BigQuery</h2>
<p>Першим кроком для отримання даних у BigQuery є створення набору даних - набору даних, який є контейнером для таблиць. У проекті можна створити кілька наборів даних. Перейдіть до <a href="https://console.cloud.google.com/bigquery">веб-консолі</a> і виберіть опцію <em>Create Dataset</em>. Потім створіть набір даних з назвою <code>dsongcp</code>.</p>
<p>Або використайте командний рядок:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bq</span> mk dsongcp</span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="завантаження-даних" class="level3">
<h3 class="anchored" data-anchor-id="завантаження-даних">Завантаження даних</h3>
<p>Ми можемо завантажити дані безпосередньо у власне сховище BigQuery за допомогою утиліти командного рядка <code>bq</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="va">PROJECT</span><span class="op">=</span><span class="va">$(</span><span class="ex">gcloud</span> config get-value project<span class="va">)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="va">BUCKET</span><span class="op">=</span><span class="va">${PROJECT}</span>-dsongcp</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="ex">bq</span> load <span class="at">--autodetect</span> <span class="at">--source_format</span><span class="op">=</span>CSV <span class="dt">\</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>dsongcp.flights_auto <span class="dt">\</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>gs://<span class="va">${BUCKET}</span>/flights/raw/201501.csv</span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ми можемо спробувати зробити запит на дані, щоб знайти середню затримку вильоту та прильоту в найбільш завантажених аеропортах:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  ORIGIN,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(DepDelay) <span class="kw">AS</span> dep_delay,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(ArrDelay) <span class="kw">AS</span> arr_delay,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(ArrDelay) <span class="kw">AS</span> num_flights</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  `dsongcp.flights_auto`</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  ORIGIN</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> num_flights <span class="kw">DESC</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span></span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Автоматичне визначення схеми дозволяє нам завантажити дані без необхідності визначення схеми. Але це може бути не найкращим варіантом для великих наборів даних. В такому випадку краще визначити схему вручну.</p>
<p>Наразі ми мало що знаємо про поля, тому можемо попросити BigQuery обробляти всі стовпці, окрім <code>FlightDate</code>, як рядки:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="va">SCHEMA</span><span class="op">=</span>Year:STRING,...,FlightDate:DATE,Reporting_Airline:STRING,...</span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Крім того, ми можемо розбити дані на партіції за допомогою поля <code>FlightDate</code>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">--time_partitioning_field=FlightDate</span> <span class="at">--time_partitioning_type</span><span class="op">=</span>MONTH</span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Тоді код для завантаження даних у BigQuery буде виглядати наступним чином:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="va">PROJECT</span><span class="op">=</span><span class="va">$(</span><span class="ex">gcloud</span> config get-value project<span class="va">)</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="va">BUCKET</span><span class="op">=</span><span class="va">${PROJECT}</span>-dsongcp</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="va">YEAR</span><span class="op">=</span>2015</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="va">SCHEMA</span><span class="op">=</span>Year:STRING,Quarter:STRING,Month:STRING,DayofMonth:STRING,DayOfWeek:STRING,FlightDate:DATE,Reporting_Airline:STRING,DOT_ID_Reporting_Airline:STRING,IATA_CODE_Reporting_Airline:STRING,Tail_Number:STRING,Flight_Number_Reporting_Airline:STRING,OriginAirportID:STRING,OriginAirportSeqID:STRING,OriginCityMarketID:STRING,Origin:STRING,OriginCityName:STRING,OriginState:STRING,OriginStateFips:STRING,OriginStateName:STRING,OriginWac:STRING,DestAirportID:STRING,DestAirportSeqID:STRING,DestCityMarketID:STRING,Dest:STRING,DestCityName:STRING,DestState:STRING,DestStateFips:STRING,DestStateName:STRING,DestWac:STRING,CRSDepTime:STRING,DepTime:STRING,DepDelay:STRING,DepDelayMinutes:STRING,DepDel15:STRING,DepartureDelayGroups:STRING,DepTimeBlk:STRING,TaxiOut:STRING,WheelsOff:STRING,WheelsOn:STRING,TaxiIn:STRING,CRSArrTime:STRING,ArrTime:STRING,ArrDelay:STRING,ArrDelayMinutes:STRING,ArrDel15:STRING,ArrivalDelayGroups:STRING,ArrTimeBlk:STRING,Cancelled:STRING,CancellationCode:STRING,Diverted:STRING,CRSElapsedTime:STRING,ActualElapsedTime:STRING,AirTime:STRING,Flights:STRING,Distance:STRING,DistanceGroup:STRING,CarrierDelay:STRING,WeatherDelay:STRING,NASDelay:STRING,SecurityDelay:STRING,LateAircraftDelay:STRING,FirstDepTime:STRING,TotalAddGTime:STRING,LongestAddGTime:STRING,DivAirportLandings:STRING,DivReachedDest:STRING,DivActualElapsedTime:STRING,DivArrDelay:STRING,DivDistance:STRING,Div1Airport:STRING,Div1AirportID:STRING,Div1AirportSeqID:STRING,Div1WheelsOn:STRING,Div1TotalGTime:STRING,Div1LongestGTime:STRING,Div1WheelsOff:STRING,Div1TailNum:STRING,Div2Airport:STRING,Div2AirportID:STRING,Div2AirportSeqID:STRING,Div2WheelsOn:STRING,Div2TotalGTime:STRING,Div2LongestGTime:STRING,Div2WheelsOff:STRING,Div2TailNum:STRING,Div3Airport:STRING,Div3AirportID:STRING,Div3AirportSeqID:STRING,Div3WheelsOn:STRING,Div3TotalGTime:STRING,Div3LongestGTime:STRING,Div3WheelsOff:STRING,Div3TailNum:STRING,Div4Airport:STRING,Div4AirportID:STRING,Div4AirportSeqID:STRING,Div4WheelsOn:STRING,Div4TotalGTime:STRING,Div4LongestGTime:STRING,Div4WheelsOff:STRING,Div4TailNum:STRING,Div5Airport:STRING,Div5AirportID:STRING,Div5AirportSeqID:STRING,Div5WheelsOn:STRING,Div5TotalGTime:STRING,Div5LongestGTime:STRING,Div5WheelsOff:STRING,Div5TailNum:STRING</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> MONTH <span class="kw">in</span> <span class="kw">`</span><span class="fu">seq</span> <span class="at">-w</span> 1 12<span class="kw">`;</span> <span class="cf">do</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="va">CSVFILE</span><span class="op">=</span>gs://<span class="va">${BUCKET}</span>/flights/raw/<span class="va">${YEAR}${MONTH}</span>.csv</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="ex">bq</span> <span class="at">--project_id</span> <span class="va">$PROJECT</span> <span class="dt">\</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>load <span class="at">--time_partitioning_field</span><span class="op">=</span>FlightDate <span class="dt">\</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>--time_partitioning_type=MONTH <span class="dt">\</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>--source_format=CSV <span class="at">--ignore_unknown_values</span> <span class="dt">\</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>--skip_leading_rows=1 <span class="at">--schema</span><span class="op">=</span><span class="va">$SCHEMA</span> <span class="dt">\</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="va">${PROJECT}</span>:dsongcp.flights_raw<span class="dt">\$</span><span class="va">${YEAR}${MONTH}</span> <span class="va">$CSVFILE</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Повний код для завантаження даних у BigQuery міститься у файлі <code>bqload.sh</code>.</p>
</section>
</section>
<section id="дашборди" class="level2">
<h2 class="anchored" data-anchor-id="дашборди">Дашборди</h2>
<section id="створення-представлень" class="level3">
<h3 class="anchored" data-anchor-id="створення-представлень">Створення представлень</h3>
<p>Представлення - це віртуальні таблиці, які можна використовувати для спрощення складних запитів. Вони не зберігають жодних даних, але можуть бути використані для обмеження доступу до даних, агрегації даних, об’єднання таблиць тощо.</p>
<p>Створимо представлення для затримок вильоту та прильоту:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">VIEW</span> dsongcp.flights <span class="kw">AS</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  FlightDate <span class="kw">AS</span> FL_DATE,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  Reporting_Airline <span class="kw">AS</span> UNIQUE_CARRIER,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  OriginAirportSeqID <span class="kw">AS</span> ORIGIN_AIRPORT_SEQ_ID,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  Origin <span class="kw">AS</span> ORIGIN,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  DestAirportSeqID <span class="kw">AS</span> DEST_AIRPORT_SEQ_ID,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  Dest <span class="kw">AS</span> DEST,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  CRSDepTime <span class="kw">AS</span> CRS_DEP_TIME,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  DepTime <span class="kw">AS</span> DEP_TIME,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(DepDelay <span class="kw">AS</span> FLOAT64) <span class="kw">AS</span> DEP_DELAY,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(TaxiOut <span class="kw">AS</span> FLOAT64) <span class="kw">AS</span> TAXI_OUT,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  WheelsOff <span class="kw">AS</span> WHEELS_OFF,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  WheelsOn <span class="kw">AS</span> WHEELS_ON,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(TaxiIn <span class="kw">AS</span> FLOAT64) <span class="kw">AS</span> TAXI_IN,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  CRSArrTime <span class="kw">AS</span> CRS_ARR_TIME,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  ArrTime <span class="kw">AS</span> ARR_TIME,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(ArrDelay <span class="kw">AS</span> FLOAT64) <span class="kw">AS</span> ARR_DELAY,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">IF</span>(Cancelled <span class="op">=</span> <span class="st">'1.00'</span>, <span class="kw">True</span>, <span class="kw">False</span>) <span class="kw">AS</span> CANCELLED,</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">IF</span>(Diverted <span class="op">=</span> <span class="st">'1.00'</span>, <span class="kw">True</span>, <span class="kw">False</span>) <span class="kw">AS</span> DIVERTED,</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  DISTANCE</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> dsongcp.flights_raw;</span></code><button title="Скопіювати текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Тепер можемо приступити до візуалізації даних.</p>
</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Примітки</h2>

<ol>
<li id="fn1"><p>Якщо у вас є кілька облікових записів Gmail, виберіть один і постійно використовуйте його, коли з’являється запит на автентифікацію нового API сервісу GCP<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Хоча хмара - це не єдина гра в місті, вона пропонує безліч переваг, які, на мою думку, роблять її безпроблемною для більшості людей: економія на масштабах робить її набагато дешевшою; турботи про обслуговування та амортизацію зняті; доступ не залежить від інституційної приналежності або статусу викладача; хмарні провайдери пропонують безліч інших корисних послуг; тощо<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Альтернативи GCP включають <a href="https://aws.amazon.com/">AWS</a> та <a href="https://www.digitalocean.com/">Digital Ocean</a>. Posit нещодавно також запустила власний хмарний сервіс: <a href="https://rstudio.cloud/">Posit Cloud</a>, який має вужчу спрямованість, але чудово підходить для навчання і є (наразі) безкоштовним для використання. Хороша новина полягає в тому, що це все чудові варіанти, а загальні принципи хмарних обчислень переносяться дуже легко. Тож використовуйте те, що вам зручніше<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Cloud Shell - це мікро-ВМ, яка існує протягом усього часу, поки відкрито вікно браузера, і надає вам термінальний доступ до мікро-ВМ. Закрийте вікно браузера, і мікро-ВМ зникне. ВМ Cloud Shell безкоштовна і постачається з багатьма інструментами, які знадобляться розробникам на Google Cloud Platform. Наприклад, на ній встановлені Python, Git, Google Cloud SDK та Orion (веб-редактор коду). Хоча віртуальна машина Cloud Shell є ефемерною, вона прикріплена до постійного диска, який прив’язаний до вашого облікового запису користувача. Файли, які ви зберігаєте в домашньому каталозі, зберігаються під час різних сеансів Cloud Shell.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Скопійовано!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Скопійовано!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>